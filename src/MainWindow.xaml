<Window x:Class="EyeLaserGame.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:EyeLaserGame"
        xmlns:viewmodels="clr-namespace:EyeLaserGame.ViewModels"
        xmlns:converters="clr-namespace:EyeLaserGame.Converters"
       
        mc:Ignorable="d"
        Title="赵露思激光眼大冒险" Height="990" Width="720"
        ResizeMode="NoResize">
    
    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <converters:PositionConverter x:Key="PositionConverter"/>
        <converters:HealthToWidthConverter x:Key="HealthToWidthConverter"/>
        <converters:HealthToColorConverter x:Key="HealthToColorConverter"/>
        <converters:HealthToStateConverter x:Key="HealthToStateConverter"/>
    </Window.Resources>
    
    <Window.DataContext>
        <viewmodels:MainViewModel />
    </Window.DataContext>
    
    <Window.InputBindings>
        <KeyBinding Key="Left" Command="{Binding MoveLeftCommand}" />
        <KeyBinding Key="A" Command="{Binding MoveLeftCommand}" />
        <KeyBinding Key="Right" Command="{Binding MoveRightCommand}" />
        <KeyBinding Key="D" Command="{Binding MoveRightCommand}" />
        <KeyBinding Key="Up" Command="{Binding MoveUpCommand}" />
        <KeyBinding Key="W" Command="{Binding MoveUpCommand}" />
        <KeyBinding Key="Down" Command="{Binding MoveDownCommand}" />
        <KeyBinding Key="S" Command="{Binding MoveDownCommand}" />
        <KeyBinding Key="Return" Command="{Binding StartGameCommand}" />
    </Window.InputBindings>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- 顶部控制区 -->
        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="10">
            <Button Content="开始游戏" Command="{Binding StartGameCommand}" Width="100" Margin="0,0,10,0"/>
            <TextBlock Text="生命:" VerticalAlignment="Center" Margin="10,0"/>
            <TextBlock Text="{Binding Lives}" VerticalAlignment="Center" Margin="5,0"/>
            <TextBlock Text="血量:" VerticalAlignment="Center" Margin="10,0"/>
            <Grid Width="150" Height="20" Margin="5,0">
                <!-- 血条背景 -->
                <Border Background="#333333" CornerRadius="3" BorderBrush="#555555" BorderThickness="1"/>
                
                <!-- 血条 -->
                <Border CornerRadius="3" HorizontalAlignment="Left" Width="{Binding Health, Converter={StaticResource HealthToWidthConverter}}">
                    <Border.Background>
                        <SolidColorBrush Color="{Binding Health, Converter={StaticResource HealthToColorConverter}}"/>
                    </Border.Background>
                    <Border.Effect>
                        <DropShadowEffect ShadowDepth="0" Color="{Binding Health, Converter={StaticResource HealthToColorConverter}}" 
                                         BlurRadius="10" Opacity="0.7"/>
                    </Border.Effect>
                </Border>
                
                <!-- 血量数字 -->
                <TextBlock Text="{Binding Health}" VerticalAlignment="Center" HorizontalAlignment="Center">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Foreground" Value="White"/>
                            <Setter Property="FontWeight" Value="Bold"/>
                            <Setter Property="FontSize" Value="12"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Health, Converter={StaticResource HealthToStateConverter}}" Value="Low">
                                    <Setter Property="Foreground" Value="Yellow"/>
                                    <Setter Property="FontWeight" Value="ExtraBold"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                    <TextBlock.Effect>
                        <DropShadowEffect ShadowDepth="1" Color="Black" Opacity="0.7" BlurRadius="1"/>
                    </TextBlock.Effect>
                </TextBlock>
            </Grid>
            <TextBlock Text="分数:" VerticalAlignment="Center" Margin="10,0"/>
            <TextBlock Text="{Binding Score}" VerticalAlignment="Center" Margin="5,0"/>
        </StackPanel>
        
        <!-- 游戏区域 -->
        <Grid Grid.Row="1">
            <!-- 背景图片 -->
            <Grid>
                <!-- 直接使用Assets文件夹中的bg.gif作为背景 -->
                <local:GifImage GifSource="pack://application:,,,/Assets/bg.gif" Stretch="Fill" AutoStart="True"/>
            </Grid>
            
            <!-- 眼睛位置标记 -->
            <Canvas>
                <!-- 左眼位置 -->
                <Ellipse Width="10" Height="10" Fill="Red" Stroke="Yellow" StrokeThickness="2"
                         Canvas.Left="{Binding LeftEyePosition.X, Converter={StaticResource PositionConverter}, ConverterParameter=-5}"
                         Canvas.Top="{Binding LeftEyePosition.Y, Converter={StaticResource PositionConverter}, ConverterParameter=-5}"
                         Visibility="{Binding IsGameRunning, Converter={StaticResource BoolToVisibilityConverter}}"/>
                
                <!-- 右眼位置 -->
                <Ellipse Width="10" Height="10" Fill="Red" Stroke="Yellow" StrokeThickness="2"
                         Canvas.Left="{Binding RightEyePosition.X, Converter={StaticResource PositionConverter}, ConverterParameter=-5}"
                         Canvas.Top="{Binding RightEyePosition.Y, Converter={StaticResource PositionConverter}, ConverterParameter=-5}"
                         Visibility="{Binding IsGameRunning, Converter={StaticResource BoolToVisibilityConverter}}"/>
                
                <!-- 激光 - 更明显的颜色和效果 -->
                <Line x:Name="LeftEyeLaser" 
                      X1="{Binding LeftEyePosition.X}" 
                      Y1="{Binding LeftEyePosition.Y}" 
                      X2="{Binding LeftLaserEndPoint.X}" 
                      Y2="{Binding LeftLaserEndPoint.Y}" 
                      Stroke="Red" 
                      StrokeThickness="15"
                      Opacity="0.9">
                    <Line.Effect>
                        <BlurEffect Radius="8"/>
                    </Line.Effect>
                    <Line.Style>
                        <Style TargetType="Line">
                            <Setter Property="Visibility" Value="Collapsed" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsLaserActive}" Value="True">
                                    <Setter Property="Visibility" Value="Visible" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Line.Style>
                </Line>
                
                <Line x:Name="RightEyeLaser" 
                      X1="{Binding RightEyePosition.X}" 
                      Y1="{Binding RightEyePosition.Y}" 
                      X2="{Binding RightLaserEndPoint.X}" 
                      Y2="{Binding RightLaserEndPoint.Y}" 
                      Stroke="Red" 
                      StrokeThickness="15"
                      Opacity="0.9">
                    <Line.Effect>
                        <BlurEffect Radius="8"/>
                    </Line.Effect>
                    <Line.Style>
                        <Style TargetType="Line">
                            <Setter Property="Visibility" Value="Collapsed" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsLaserActive}" Value="True">
                                    <Setter Property="Visibility" Value="Visible" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Line.Style>
                </Line>
                
                <!-- 激光内核 - 更亮的中心部分 -->
                <Line x:Name="LeftEyeLaserCore" 
                      X1="{Binding LeftEyePosition.X}" 
                      Y1="{Binding LeftEyePosition.Y}" 
                      X2="{Binding LeftLaserEndPoint.X}" 
                      Y2="{Binding LeftLaserEndPoint.Y}" 
                      Stroke="White" 
                      StrokeThickness="5"
                      Opacity="1.0">
                    <Line.Style>
                        <Style TargetType="Line">
                            <Setter Property="Visibility" Value="Collapsed" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsLaserActive}" Value="True">
                                    <Setter Property="Visibility" Value="Visible" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Line.Style>
                </Line>
                
                <Line x:Name="RightEyeLaserCore" 
                      X1="{Binding RightEyePosition.X}" 
                      Y1="{Binding RightEyePosition.Y}" 
                      X2="{Binding RightLaserEndPoint.X}" 
                      Y2="{Binding RightLaserEndPoint.Y}" 
                      Stroke="White" 
                      StrokeThickness="5"
                      Opacity="1.0">
                    <Line.Style>
                        <Style TargetType="Line">
                            <Setter Property="Visibility" Value="Collapsed" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsLaserActive}" Value="True">
                                    <Setter Property="Visibility" Value="Visible" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Line.Style>
                </Line>
                
                <!-- 光点 -->
                <ItemsControl ItemsSource="{Binding LightParticles}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <Canvas />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemContainerStyle>
                        <Style TargetType="ContentPresenter">
                            <Setter Property="Canvas.Left" Value="{Binding X, Converter={StaticResource PositionConverter}, ConverterParameter=-3}" />
                            <Setter Property="Canvas.Top" Value="{Binding Y, Converter={StaticResource PositionConverter}, ConverterParameter=-3}" />
                        </Style>
                    </ItemsControl.ItemContainerStyle>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Grid>
                                <!-- 光点外发光效果 -->
                                <Ellipse Width="16" Height="16" Fill="#80FF0000" Opacity="0.7">
                                    <Ellipse.Effect>
                                        <BlurEffect Radius="6"/>
                                    </Ellipse.Effect>
                                    <Ellipse.Style>
                                        <Style TargetType="Ellipse">
                                            <Setter Property="Visibility" Value="Visible" />
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding X}" Value="-1">
                                                    <Setter Property="Visibility" Value="Collapsed" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Ellipse.Style>
                                </Ellipse>
                                
                                <!-- 光点中心 -->
                                <Ellipse Width="8" Height="8" Fill="Yellow" Stroke="Red" StrokeThickness="1.5">
                                    <Ellipse.Style>
                                        <Style TargetType="Ellipse">
                                            <Setter Property="Visibility" Value="Visible" />
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding X}" Value="-1">
                                                    <Setter Property="Visibility" Value="Collapsed" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Ellipse.Style>
                                </Ellipse>
                            </Grid>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
                
                <!-- 玩家角色 -->
                <Image x:Name="PlayerImage" Width="60" Height="80" 
                       Canvas.Left="{Binding PlayerPosition.X, Converter={StaticResource PositionConverter}, ConverterParameter=-30}"
                       Canvas.Top="{Binding PlayerPosition.Y, Converter={StaticResource PositionConverter}, ConverterParameter=-40}"
                       Visibility="{Binding IsGameRunning, Converter={StaticResource BoolToVisibilityConverter}}">
                    <Image.Source>
                        <BitmapImage UriSource="pack://application:,,,/Assets/player.png"/>
                    </Image.Source>
                    <Image.Style>
                        <Style TargetType="Image">
                            <Setter Property="Opacity" Value="1.0" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsPlayerColliding}" Value="True">
                                    <Setter Property="Opacity" Value="0.5" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Image.Style>
                </Image>
            </Canvas>
        </Grid>
        
        <!-- 底部状态栏 -->
        <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="10">
            <TextBlock Text="按Enter键或点击开始游戏按钮开始游戏。使用方向键或WASD键移动角色，躲避赵露思的激光！被射中后有短暂的无敌buff。" VerticalAlignment="Center" TextWrapping="Wrap"/>
        </StackPanel>
    </Grid>
</Window>